(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const V of c.addedNodes)V.tagName==="LINK"&&V.rel==="modulepreload"&&n(V)}).observe(document,{childList:!0,subtree:!0});function r(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(s){if(s.ep)return;s.ep=!0;const c=r(s);fetch(s.href,c)}})();const x=/Android|webOS|iPhone|iPad|Mobile|Tablet/i.test(navigator.userAgent)?"mobile":"desktop",u={a:"日",b:"月",c:"金",d:"木",e:"水",f:"火",g:"土",h:"竹",i:"戈",j:"十",k:"大",l:"中",m:"一",n:"弓",o:"人",p:"心",q:"手",r:"口",s:"尸",t:"廿",u:"山",v:"女",w:"田",x:"難",y:"卜",z:"重",",":"，",".":"。",";":"；"},a={faded:"decomposed-character-faded",selected:"decomposed-character-selected"},d={blink:"keyboard-key-blink",activated:{correct:"keyboard-key-activated-correct",incorrect:"keyboard-key-activated-incorrect"}},I=import.meta.BASE_URL,m=document.querySelector("#input-box"),b=document.querySelector("#test-char"),C=document.querySelector("#cangjie-select"),l=Array.from(document.querySelector("#decomposed-characters").children),f=Object.fromEntries(Array.from(Object.keys(u),t=>[t,document.getElementById(`keyboard-key-${t}`)])),v=(t,e,r=!0)=>(r&&document.documentElement.setAttribute(t,e),localStorage.setItem(t,e),e),g=(t,e)=>localStorage.getItem(t)||e,w=()=>{b.classList.add("shake"),setTimeout(()=>{b.classList.remove("shake")},200)},y=(t,e=!0)=>{throw e&&alert(t),console.error(t),new Error(t)};class E{#e;#t;#r;#s;constructor(e=[]){e.length===0&&y("No values passed for cycling",!1),this.#e=0,this.#t=e,this.#r=this.#t.length,this.#s=this.#t[this.#e]}next(){this.#e=(this.#e+1)%this.#r,this.#s=this.#t[this.#e]}prev(){this.#e=(this.#e-1+this.#r)%this.#r,this.#s=this.#t[this.#e]}start(){this.#e=0,this.#s=this.#t[this.#e]}end(){this.#e=this.#r-1,this.#s=this.#t[this.#e]}setByValue(e){this.#t.includes(e)||y(`${e} not in values to cycle`,!1),this.#e=this.#t.indexOf(e),this.#s=this.#t[this.#e]}get currentValue(){return this.#s}}class j{#e;#t;#r;#s;#n;#o;#i;constructor(){this.#e="",this.#t=0,this.#r=void 0,this.#s="",this.#n=void 0,this.#o=new E([!1,!0]),this.#i=Number(g("practiceIndex",0))}newTestCharacter(e){this.#e=e,this.#t=this.#e.length,this.#r=0,this.#s=this.#e[this.#r],this.#n=l[this.#r]}resetPracticeIndex(){this.#i=v("practiceIndex",0,!1)}incrementCodePosition(e=1){return this.#r+e===this.#t?(this.#i=v("practiceIndex",this.#i+1,!1),0):(this.#r+=e,this.#s=this.#e[this.#r],this.#n=l[this.#r],e)}get testCharCode(){return this.#e}get testCharCodeLength(){return this.#t}get currentIndex(){return this.#r}get currentChar(){return this.#s}get currentDecomposedChar(){return this.#n}get metaState(){return this.#o}get practiceIndex(){return this.#i}get metaStateValue(){return this.#o.currentValue}}const i=new j;class p extends E{#e;constructor(e=[],r){super(e),(r.length!==2||typeof r[0]!="string"||typeof r[1]!="boolean")&&y("saveParams not to spec, expected list: [string, boolean]",!1),this.#e=r}#t(){v(this.#e[0],this.currentValue,this.#e[1])}next(){super.next(),this.#t()}prev(){super.prev(),this.#t()}start(){super.start(),this.#t()}end(){super.end(),this.#t()}setByValue(e){super.setByValue(e),this.#t()}}class P{#e;#t;#r;#s;constructor(){this.#t=new p(["light","dark","forest","ocean","apple","ice","fire","royalty"],["theme",!0]),this.#r=new p(["hk","tw"],["regionPreference",!1]),this.#e=new p(["layout","decomposition"],["mode",!0]),this.#s=new p(["visible","hidden"],["kbVisibility",!0])}get mode(){return this.#e}get theme(){return this.#t}get regionPreference(){return this.#r}get kbVisibility(){return this.#s}get modeValue(){return this.#e.currentValue}get themeValue(){return this.#t.currentValue}get regionPreferenceValue(){return this.#r.currentValue}get kbVisibilityValue(){return this.#s.currentValue}}const o=new P,O=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";o.theme.setByValue(g("theme",O));o.mode.setByValue(g("mode",o.modeValue));o.regionPreference.setByValue(g("regionPreference",o.regionPreferenceValue));o.kbVisibility.setByValue(g("kbVisibility",o.kbVisibilityValue));let h=JSON.parse(localStorage.getItem("cangjieCodeTable"))||{};document.querySelector("#theme-toggle").addEventListener("click",t=>{t.button===0?o.theme.next():o.theme.prev()});document.querySelector("#kb-toggle").addEventListener("click",()=>{o.kbVisibility.next()});document.querySelector("#mode-toggle").addEventListener("click",()=>{o.mode.next(),S()});document.getElementsByName(`region-${o.regionPreference.currentValue}`)[0].selected=!0;C.addEventListener("change",()=>{o.regionPreference.next(),S(),C.blur()});x==="mobile"?(document.querySelector("main").addEventListener("click",()=>{document.activeElement!==m&&m.focus()}),m.addEventListener("keydown",k),m.addEventListener("keyup",L)):(document.addEventListener("keydown",k),document.addEventListener("keyup",L));document.querySelector("#keyboard").addEventListener("mousedown",k);document.querySelector("#keyboard").addEventListener("mouseup",L);document.querySelector("#keyboard").addEventListener("touchstart",k);document.querySelector("#keyboard").addEventListener("touchend",L);document.querySelector("#decomposed-characters").addEventListener("click",D);S();async function q(){const t=localStorage.getItem("segment_details");let e="a";if(t){const r=JSON.parse(t)["segment-index"];e=r===4?"a":String.fromCharCode(98+r)}await fetch(`${I}cangjieCodeTable-${e}.min.json.gz`).then(r=>{if(!r.ok){const s=`A network error occurred, the request to fetch a certain program resource has failed with ${r.status}: ${r.statusText}.`;y(s)}if(r.headers.get("Content-Encoding")==="gzip")return r.json();const n=new DecompressionStream("gzip");return new Response(r.body.pipeThrough(n)).json()}).then(r=>{(!r||typeof r!="object")&&y("An error occurred whilst processing a certain program resource."),h={};const n=Object.keys(r.data);for(let s=0;s<n.length-1;s++){const c=s+Math.floor(Math.random()*(n.length-s));[n[s],n[c]]=[n[c],n[s]]}for(const s of n)h[s]=r.data[s];localStorage.setItem("cangjieCodeTable",JSON.stringify(h)),localStorage.setItem("segment_details",JSON.stringify(r.details))}),i.resetPracticeIndex()}async function S(){C.disabled=!0,document.querySelectorAll(d.blink).forEach(r=>r.classList.remove(d.blink));let t=Object.keys(h)[i.practiceIndex];t||(await q(),t=Object.keys(h)[i.practiceIndex]);const e=h[t];typeof e=="object"?(C.disabled=!1,i.newTestCharacter(e[o.regionPreferenceValue])):i.newTestCharacter(e),b.textContent=t,b.href=`https://www.hkcards.com/cj/cj-char-${t}.html`;for(const[r,n]of Object.entries(l))n.style.display="inline-block",n.classList.remove(a.faded,a.selected),n.textContent=o.modeValue==="layout"?u[i.testCharCode[r]]:"";Array.from(l).slice(i.testCharCodeLength).forEach(r=>r.style.display="none"),o.modeValue==="layout"&&(f[i.currentChar].classList.add(d.blink),l[0].classList.add(a.selected))}function k(t){let e;if(t.type==="keydown")e=t.key.toLowerCase();else{const n=t.target.closest(".keyboard-key");if(!n)return;e=n.id.slice(-1)}(o.modeValue==="layout"?T(e):B(e))||(i.incrementCodePosition()?o.modeValue==="layout"&&(i.currentDecomposedChar.classList.add(a.selected),f[i.currentChar].classList.add(d.blink)):S())}function T(t=""){if(t===" ")return o.kbVisibility.next(),1;if(t==="meta")return i.metaState.setByValue(!0),1;if(i.metaStateValue)return w(),1;const e=f[t];return e?t!==i.currentChar?(e.classList.add(d.activated.incorrect),1):(e.classList.add(d.activated.correct),i.currentDecomposedChar.classList.remove(a.selected),i.currentDecomposedChar.classList.add(a.faded),e.classList.remove(d.blink),0):1}function B(t=""){if(t===" ")return!i.currentDecomposedChar.classList.contains(a.faded)&&!i.currentDecomposedChar.textContent&&(i.currentDecomposedChar.textContent=u[i.currentChar],i.currentDecomposedChar.classList.add(a.faded)),1;if(t==="enter"){for(const[e,r]of Object.entries(l))r.classList.contains(a.faded)||r.textContent||(r.textContent=u[i.testCharCode[e]],r.classList.add(a.faded));return 1}return t!==i.currentChar?(w(),1):(i.currentDecomposedChar.classList.remove(a.faded),i.currentDecomposedChar.textContent=u[t],0)}function D(t){const e=t.target.closest(".decomposed-character");if(!e||o.modeValue!=="decomposition")return;const r=Number(e.id.slice(-1))-1,n=l[r];!n.classList.contains(a.faded)&&!n.textContent&&(n.textContent=u[i.testCharCode[r]],n.classList.add(a.faded))}function L(t){if(o.mode.currentValue!=="layout")return;const e=t.type==="keyup"?t.key.toLowerCase():t.target.id.slice(-1);if(e==="meta"){i.metaState.setByValue(!1);return}f[e]&&f[e].classList.remove(d.activated.correct,d.activated.incorrect),x==="mobile"&&(m.value="")}
